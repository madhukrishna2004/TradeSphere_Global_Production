<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="AI chatbot for HS codes, trade duties, and origin rules, powered by xAI and OpenAI">
    <title>KlynnAI - HS Code Assistant</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background: #E6F0FA; /* Light pastel blue */
            color: #1A2A44; /* Dark navy for contrast */
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            overflow: hidden;
        }

        .chat-container {
            width: 90%;
            max-width: 800px;
            background: #FFFFFF; /* White for clean look */
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
            height: 90vh;
        }

        .chat-header {
            padding: 16px;
            background: #B3CDE0; /* Pastel blue header */
            text-align: center;
            border-top-left-radius: 12px;
            border-top-right-radius: 12px;
        }

        .chat-header h1 {
            font-size: 1.5rem;
            font-weight: 600;
            color: #1A2A44;
        }

        .chat-header p {
            font-size: 0.9rem;
            color: #4B6CB7; /* Darker pastel blue */
            opacity: 0.9;
        }

        .chat-box {
            flex: 1;
            padding: 16px;
            overflow-y: auto;
            background: #F7F9FC; /* Very light pastel blue */
            scroll-behavior: smooth;
        }

        .message {
            margin: 8px 0;
            padding: 12px;
            border-radius: 8px;
            max-width: 80%;
            line-height: 1.5;
            font-size: 0.95rem;
        }

        .message.user {
            background: #8CB3D9; /* Medium pastel blue */
            color: #FFFFFF;
            margin-left: auto;
            text-align: right;
        }

        .message.assistant {
            background: #E6F0FA; /* Light pastel blue */
            color: #1A2A44;
            margin-right: auto;
        }

        .candidates, .result {
            background: #E6F0FA;
            padding: 12px;
            border-radius: 8px;
            margin: 8px 0;
            max-width: 80%;
        }

        .candidates h3, .result h3 {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 8px;
            color: #1A2A44;
        }

        .candidates div, .result div {
            margin-bottom: 8px;
            font-size: 0.9rem;
        }

        .questions {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin: 8px 0;
            max-width: 80%;
        }

        .question {
            background: #E6F0FA;
            padding: 12px;
            border-radius: 8px;
        }

        .question p {
            font-weight: 600;
            margin-bottom: 8px;
            color: #1A2A44;
        }

        .question select {
            padding: 8px;
            border: 1px solid #8CB3D9;
            border-radius: 6px;
            font-size: 0.9rem;
            width: 100%;
            max-width: 200px;
            margin-bottom: 8px;
        }

        .question-btn, .feedback-btn, .submit-btn, .ok-btn {
            background: #4B6CB7; /* Darker pastel blue */
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            color: #FFFFFF;
            margin: 4px;
            font-size: 0.9rem;
            transition: background 0.2s;
        }

        .question-btn:hover, .feedback-btn:hover, .submit-btn:hover, .ok-btn:hover {
            background: #3A569A; /* Slightly darker for hover */
        }

        .input-container {
            display: flex;
            padding: 16px;
            background: #B3CDE0;
            border-bottom-left-radius: 12px;
            border-bottom-right-radius: 12px;
        }

        #user-input {
            flex: 1;
            padding: 10px;
            border: 1px solid #8CB3D9;
            border-radius: 6px;
            margin-right: 8px;
            font-size: 0.95rem;
            background: #FFFFFF;
            color: #1A2A44;
        }

        #user-input:focus {
            outline: none;
            border-color: #4B6CB7;
            box-shadow: 0 0 4px rgba(75, 108, 183, 0.3);
        }

        .input-container button {
            padding: 10px 20px;
            background: #4B6CB7;
            border: none;
            border-radius: 6px;
            color: #FFFFFF;
            cursor: pointer;
            font-size: 0.95rem;
        }

        .input-container button:hover {
            background: #3A569A;
        }

        .loading {
            text-align: center;
            padding: 8px;
            color: #4B6CB7;
            font-size: 0.95rem;
        }

        .loading span {
            display: inline-block;
            animation: blink 1.4s infinite;
        }

        .loading span:nth-child(2) { animation-delay: 0.2s; }
        .loading span:nth-child(3) { animation-delay: 0.4s; }

        @keyframes blink {
            0%, 80%, 100% { opacity: 0; }
            40% { opacity: 1; }
        }

        @media (max-width: 600px) {
            .chat-container {
                width: 95%;
                height: 95vh;
            }

            .chat-header h1 {
                font-size: 1.25rem;
            }

            .chat-header p {
                font-size: 0.85rem;
            }

            .message, .candidates, .result, .questions {
                max-width: 90%;
            }

            .input-container {
                padding: 12px;
            }

            #user-input, .input-container button {
                font-size: 0.9rem;
            }
        }
    </style>
</head>
<body>
    <div class="chat-container">
        <div class="chat-header">
            <h1>KlynnAI - HS Code Assistant v4.4.2</h1>
            <p>Production-grade classification for trade compliance</p>
        </div>
        <div class="chat-box" id="chat-box">
            <div class="message assistant">
                Welcome to KlynnAI. I can assist with HS code classification, trade duties, and tariff-related questions. Please describe an item (e.g., 'stainless steel screws') or ask a question to begin.
            </div>
        </div>
        <div class="input-container">
            <input type="text" id="user-input" placeholder="Describe an item or ask a question..." aria-label="Enter your query" autofocus>
            <button onclick="sendMessage()" aria-label="Submit query">Submit</button>
        </div>
        <div class="loading" id="loading" style="display: none;">
            <span>.</span><span>.</span><span>.</span>
        </div>
    </div>
    <script>
        const chatBox = document.getElementById('chat-box');
        const userInput = document.getElementById('user-input');
        const loading = document.getElementById('loading');
        let currentQuestions = [];

        function appendMessage(content, role) {
            const div = document.createElement('div');
            div.className = `message ${role}`;
            div.innerHTML = content.replace(/\n/g, '<br>');
            chatBox.appendChild(div);
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        function appendCandidates(candidates) {
            const div = document.createElement('div');
            div.className = 'candidates';
            div.innerHTML = '<h3>Top Matching HS Codes</h3>';
            candidates.forEach(c => {
                div.innerHTML += `
                    <div>
                        HS Code: ${c.hs_code}<br>
                        Description: ${c.description}<br>
                        Confidence: ${c.confidence}<br>
                    </div>
                `;
            });
            chatBox.appendChild(div);
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        function appendQuestions(questions) {
            currentQuestions = questions;
            const div = document.createElement('div');
            div.className = 'questions';
            questions.forEach(q => {
                const qDiv = document.createElement('div');
                qDiv.className = 'question';
                qDiv.innerHTML = `<p>${q.question}</p>`;
                const select = document.createElement('select');
                select.id = `select-${q.key}`;
                select.innerHTML = `<option value="">Select an option</option>` +
                    q.options.map(opt => `<option value="${opt}">${opt}</option>`).join('') +
                    `<option value="skip">Skip</option>`;
                qDiv.appendChild(select);
                div.appendChild(qDiv);
            });
            const submitBtn = document.createElement('button');
            submitBtn.className = 'submit-btn';
            submitBtn.innerText = 'Submit';
            submitBtn.onclick = submitSelections;
            div.appendChild(submitBtn);
            chatBox.appendChild(div);
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        function appendResult(result) {
            const div = document.createElement('div');
            div.className = 'result';
            div.innerHTML = `
                <h3>Final HS Code Classification</h3>
                HS Code: ${result.hs_code}<br>
                Description: ${result.description}<br>
                Confidence: ${result.confidence}<br>
                Explanation: ${result.explanation}<br>
                Category: ${result.category}<br>
                Details:<br>
                - CET Duty Rate: ${result.details.cet_duty_rate}<br>
                - UKGT Duty Rate: ${result.details.ukgt_duty_rate}<br>
                - VAT Rate: ${result.details.vat_rate}<br>
            `;
            chatBox.appendChild(div);
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        function appendFeedbackPrompt(prompt) {
            const div = document.createElement('div');
            div.className = 'questions';
            div.innerHTML = `<p>${prompt}</p>`;
            ['Yes', 'No', 'Skip'].forEach(opt => {
                const btn = document.createElement('button');
                btn.className = 'feedback-btn';
                btn.innerText = opt;
                btn.onclick = () => {
                    if (opt === 'No') {
                        const correctHs = prompt('Enter the correct HS code (optional, press OK to skip):');
                        userInput.value = JSON.stringify({ feedback: opt.toLowerCase(), correct_hs_code: correctHs || '' });
                    } else {
                        userInput.value = JSON.stringify({ feedback: opt.toLowerCase() });
                    }
                    sendMessage();
                };
                div.appendChild(btn);
            });
            const okBtn = document.createElement('button');
            okBtn.className = 'ok-btn';
            okBtn.innerText = 'OK';
            okBtn.onclick = () => {
                userInput.value = JSON.stringify({ feedback: 'skip' });
                sendMessage();
            };
            div.appendChild(okBtn);
            chatBox.appendChild(div);
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        function submitSelections() {
            const answers = {};
            currentQuestions.forEach(q => {
                const select = document.getElementById(`select-${q.key}`);
                if (select.value) {
                    answers[q.key] = select.value;
                }
            });
            if (Object.keys(answers).length === 0) {
                appendMessage('Please select at least one option or skip.', 'assistant');
                return;
            }
            userInput.value = JSON.stringify(answers);
            sendMessage();
        }

        async function sendMessage() {
            const input = userInput.value.trim();
            if (!input) return;

            appendMessage(input.startsWith('{') ? 'Selected: ' + (JSON.parse(input).feedback || Object.values(JSON.parse(input))[0]) : input, 'user');
            userInput.value = '';
            loading.style.display = 'block';

            try {
                const response = await fetch('/chatbot/ask', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ user_input: input })
                });
                const data = await response.json();

                loading.style.display = 'none';

                if (data.error) {
                    appendMessage(data.error, 'assistant');
                } else if (data.type === 'candidates') {
                    appendMessage(data.response, 'assistant');
                    appendCandidates(data.candidates);
                    if (data.questions) appendQuestions(data.questions);
                } else if (data.type === 'final') {
                    appendMessage(data.response, 'assistant');
                    appendResult(data.result);
                    appendFeedbackPrompt(data.feedback_prompt);
                } else if (data.type === 'feedback') {
                    appendMessage(data.response, 'assistant');
                } else {
                    appendMessage(data.response, 'assistant');
                }
            } catch (error) {
                loading.style.display = 'none';
                appendMessage('Error: Unable to connect to server. Please try again.', 'assistant');
                console.error('Error:', error);
            }
        }

        userInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) sendMessage();
        });
    </script>
</body>
</html>